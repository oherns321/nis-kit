// media query match that indicates mobile/tablet width
const isMobile = window.matchMedia('(max-width: 882px)');

/**
 * Toggles the mobile navigation menu
 * @param {Element} mobileHeader The mobile header element
 */
function toggleMobileMenu(mobileHeader) {
  const isOpen = mobileHeader.classList.contains('is-open');

  if (isOpen) {
    mobileHeader.classList.remove('is-open');
    document.body.style.overflowY = '';
  } else {
    mobileHeader.classList.add('is-open');
    document.body.style.overflowY = 'hidden';
  }
}

/**
 * Opens the search modal
 */
function openSearchModal() {
  const searchModal = document.querySelector('.SearchModal');
  if (searchModal) {
    searchModal.classList.add('is-open');
    const searchInput = searchModal.querySelector('#modal-search-input');
    if (searchInput) {
      searchInput.focus();
    }
  }
}

/**
 * Closes the search modal
 */
function closeSearchModal() {
  const searchModal = document.querySelector('.SearchModal');
  if (searchModal) {
    searchModal.classList.remove('is-open');
  }
}

/**
 * Handles keyboard events for accessibility
 */
function handleKeyboardEvents(e) {
  if (e.code === 'Escape') {
    const searchModal = document.querySelector('.SearchModal');
    if (searchModal && searchModal.classList.contains('is-open')) {
      closeSearchModal();
    }

    const mobileHeader = document.querySelector('.SiteHeader--mobile.is-open');
    if (mobileHeader) {
      toggleMobileMenu(mobileHeader);
    }
  }
}

/**
 * Creates the search modal structure
 */
function createSearchModal() {
  const searchModal = document.createElement('div');
  searchModal.className = 'SearchModal';
  searchModal.innerHTML = `
    <div class="form-field text-center">
      <input type="text" name="modal-search" id="modal-search-input" placeholder="Search" autocomplete="off">
      <button class="btn btn-primary btnSearch" id="modal-search">
        <span class="text">Search</span>
        <span class="glyphicon glyphicon-search"></span>
      </button>
    </div>
  `;

  // Close modal when clicking outside
  searchModal.addEventListener('click', (e) => {
    if (e.target === searchModal) {
      closeSearchModal();
    }
  });

  // Handle search button click
  const searchButton = searchModal.querySelector('#modal-search');
  searchButton.addEventListener('click', () => {
    const searchTerm = searchModal.querySelector('#modal-search-input').value;
    if (searchTerm.trim()) {
      // Implement search functionality here
      // TODO: Replace with actual search implementation
      window.location.href = `/search?q=${encodeURIComponent(searchTerm)}`;
      closeSearchModal();
    }
  });

  return searchModal;
}

/**
 * loads and decorates the header, mainly the nav
 * @param {Element} block The header block element
 */
export default async function decorate(block) {
  // Create header structure matching Columbia Gas SiteHeader design
  block.textContent = '';

  // Create search modal
  const searchModal = createSearchModal();
  document.body.appendChild(searchModal);

  // Desktop Header
  const desktopHeader = document.createElement('div');
  desktopHeader.className = 'SiteHeader SiteHeader--desktop';

  const desktopContainer = document.createElement('div');
  desktopContainer.className = 'container';

  // Desktop Logo
  const desktopLogo = document.createElement('a');
  desktopLogo.className = 'image logo';
  desktopLogo.href = '/';

  const desktopLogoImg = document.createElement('img');
  desktopLogoImg.src = '/content/adobe-code-kit.resource/icons/wordmark.svg';
  desktopLogoImg.alt = 'Columbia Gas Logo';
  desktopLogo.appendChild(desktopLogoImg);

  // Desktop Main Navigation
  const mainNavigation = document.createElement('div');
  mainNavigation.id = 'main-navigation';
  mainNavigation.className = 'MainNav MainNav--desktop';
  mainNavigation.setAttribute('tabindex', '-1');

  // Auxiliary navigation
  const auxNav = document.createElement('div');
  auxNav.className = 'MainNav__auxiliary';
  const auxList = document.createElement('ul');

  const auxItems = [
    { text: 'Our Company', href: '/our-company' },
    { text: 'Partner with Us', href: '/partner-with-us' },
    { text: 'Emergency Contact', href: 'tel:+18001234567', isEmergency: true },
  ];

  auxItems.forEach((item) => {
    const li = document.createElement('li');
    li.className = 'menu-item';

    const link = document.createElement('a');
    link.href = item.href;
    link.textContent = item.text;
    link.target = '_self';

    if (item.isEmergency) {
      link.className = 'color-red';
      const icon = document.createElement('img');
      icon.src = '/icons/warning.svg';
      icon.alt = 'Warning';
      icon.className = 'icon icon-warning-2';
      icon.style.width = '16px';
      icon.style.height = '16px';
      link.prepend(icon);
    }

    li.appendChild(link);
    auxList.appendChild(li);
  });

  // Add search trigger to auxiliary nav
  const searchLi = document.createElement('li');
  const searchTrigger = document.createElement('div');
  searchTrigger.className = 'SearchModalDesktopTrigger';

  const searchIcon = document.createElement('img');
  searchIcon.src = '/icons/search.svg';
  searchIcon.alt = 'Search';
  searchIcon.className = 'search-icon';
  searchTrigger.appendChild(searchIcon);

  searchTrigger.addEventListener('click', openSearchModal);
  searchLi.appendChild(searchTrigger);
  auxList.appendChild(searchLi);

  auxNav.appendChild(auxList);

  // Main navigation
  const mainNav = document.createElement('div');
  mainNav.className = 'MainNav__main';
  const mainList = document.createElement('ul');

  const mainItems = [
    { text: 'My Account', href: '#' },
    { text: 'Bills & Payments', href: '#' },
    { text: 'Services', href: '#' },
    { text: 'Safety', href: '#' },
  ];

  mainItems.forEach((item) => {
    const li = document.createElement('li');
    const link = document.createElement('a');
    link.href = item.href;
    link.textContent = item.text;
    li.appendChild(link);
    mainList.appendChild(li);
  });

  mainNav.appendChild(mainList);
  mainNavigation.appendChild(auxNav);
  mainNavigation.appendChild(mainNav);

  desktopContainer.appendChild(desktopLogo);
  desktopContainer.appendChild(mainNavigation);
  desktopHeader.appendChild(desktopContainer);

  // Mobile Header
  const mobileHeader = document.createElement('div');
  mobileHeader.className = 'SiteHeader SiteHeader--mobile';

  // Mobile always visible section
  const mobileAlwaysVisible = document.createElement('div');
  mobileAlwaysVisible.className = 'SiteHeader__mobile-always-visible';

  // Mobile Logo
  const mobileLogo = document.createElement('a');
  mobileLogo.className = 'image logo';
  mobileLogo.href = '/';

  const mobileLogoImg = document.createElement('img');
  mobileLogoImg.src = '/content/adobe-code-kit.resource/icons/wordmark.svg';
  mobileLogoImg.alt = 'Logo';
  mobileLogo.appendChild(mobileLogoImg);

  // Mobile controls (search + menu toggle)
  const mobileControls = document.createElement('div');
  mobileControls.className = 'flex';

  const mobileSearchTrigger = document.createElement('div');
  mobileSearchTrigger.className = 'SearchModalMobileTrigger';

  const mobileSearchIcon = document.createElement('img');
  mobileSearchIcon.src = '/icons/search.svg';
  mobileSearchIcon.alt = 'Search';
  mobileSearchIcon.className = 'search-icon';
  mobileSearchTrigger.appendChild(mobileSearchIcon);

  mobileSearchTrigger.addEventListener('click', openSearchModal);

  const toggleNavigation = document.createElement('div');
  toggleNavigation.className = 'toggle-navigation';

  const openIcon = document.createElement('img');
  openIcon.src = '/icons/menu-open.svg';
  openIcon.alt = 'Open menu';
  openIcon.className = 'icon icon-open-menu';

  const openSpan = document.createElement('span');
  openSpan.className = 'icon-open-menu';
  openSpan.textContent = 'menu';

  const closeIcon = document.createElement('img');
  closeIcon.src = '/icons/menu-close.svg';
  closeIcon.alt = 'Close menu';
  closeIcon.className = 'icon icon-close-menu';

  const closeSpan = document.createElement('span');
  closeSpan.className = 'icon-close-menu';
  closeSpan.textContent = 'close';

  toggleNavigation.appendChild(openIcon);
  toggleNavigation.appendChild(openSpan);
  toggleNavigation.appendChild(closeIcon);
  toggleNavigation.appendChild(closeSpan);

  toggleNavigation.addEventListener('click', () => toggleMobileMenu(mobileHeader));

  mobileControls.appendChild(mobileSearchTrigger);
  mobileControls.appendChild(toggleNavigation);

  mobileAlwaysVisible.appendChild(mobileLogo);
  mobileAlwaysVisible.appendChild(mobileControls);

  // Mobile navigation menu
  const mobileNav = document.createElement('div');
  mobileNav.className = 'MobileNav';

  const mobileNavMain = document.createElement('div');
  mobileNavMain.className = 'MobileNav__main';

  const mobileNavList = document.createElement('ul');

  const mobileNavItems = [
    { text: 'My Account', href: '#' },
    { text: 'Bills & Payments', href: '#' },
    { text: 'Services', href: '#' },
    { text: 'Safety', href: '#' },
    { text: 'Our Company', href: '/our-company' },
    { text: 'Partner with Us', href: '/partner-with-us' },
    { text: 'Emergency Contact', href: 'tel:+18001234567' },
  ];

  mobileNavItems.forEach((item) => {
    const li = document.createElement('li');
    const link = document.createElement('a');
    link.href = item.href;
    link.textContent = item.text;
    li.appendChild(link);
    mobileNavList.appendChild(li);
  });

  mobileNavMain.appendChild(mobileNavList);
  mobileNav.appendChild(mobileNavMain);

  mobileHeader.appendChild(mobileAlwaysVisible);
  mobileHeader.appendChild(mobileNav);

  // Assemble the complete header
  block.appendChild(desktopHeader);
  block.appendChild(mobileHeader);

  // Add keyboard event listeners
  window.addEventListener('keydown', handleKeyboardEvents);

  // Handle responsive behavior
  isMobile.addEventListener('change', () => {
    if (!isMobile.matches) {
      // Switching to desktop - close mobile menu
      mobileHeader.classList.remove('is-open');
      document.body.style.overflowY = '';
    }
  });
}
